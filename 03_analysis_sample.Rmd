---
title: "Watershed Assessment Unit Analysis"
subtitle: "Layer Summary: Old Growth (Priority Deferral Areas)"
author: "Environmental Reporting BC"
date: "24/1/2022"
output: pdf_document
number_sections: true 
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

source('header.R')
source('packages.R')
```

```{r load gpkg, include=FALSE}
wau_analysis <- st_read("data/wshd_w_elements.gpkg", crs=3005) %>%
  st_cast(to="MULTIPOLYGON") %>%
  st_make_valid() %>%
  st_drop_geometry()

```

# Introduction and Rationale

This document presents the output of the Old Growth (Priority Deferral Area) layer analyzed to the watershed assessment unit (WAU) level. The code used to generate this output could be applied to any layer of interest. This project is set up that each new layer is loaded, converted to the right specs (01_load.R), extracted to WAU (02_clean.R), and then binned (03_analysis.R).The original WAU layer is then re-written with the new layer. This workflow will create flexibility in whatever layers are added in the future.
 
The hectares from each of our input layers have been extracted into WAUs and were preliminarily binned (these bins should not be used for analysis at this time). 

# Old Growth Layer Analysis

Depending on the layer, different transformations will fit the data best, but due to data type, most will have skewed right distributions (long right tail). Here we have created a log transformation column (for right-skewed data) and a square root transformation column (for left skewed data) to test which transformation is the right fit. Note that 0's were removed and made 'none'. Below we have also included plots for a natural breaks (Jenks) transformation, which is best suited to  data that is unevenly distributed but not skewed towards either end of the distribution.

```{r f_own, echo=FALSE, results='asis'}
wau_working <- wau_analysis %>%
  mutate(og_perc = round(OG_ha/ASSESSMENT_UNIT_AREA_HA*100, 2)) %>%
  mutate(log_OG = ifelse(OG_ha > 0, log(OG_ha), NA)) %>%
  mutate (sqrt_OG = ifelse(OG_ha >0, sqrt(OG_ha), NA)) # for right-skewed data

wau_jenks <- getJenksBreaks(wau_analysis$OG_ha, 10)

new_layer_summary <- wau_working %>%
  filter(OG_ha > 0) %>%
  summarise(r_mean = signif(mean(OG_ha, 3)),
            r_med = signif(median(OG_ha, na.rm = TRUE), 3),
            r_20 = signif(quantile(OG_ha, prob=0.20, na.rm = TRUE), 3),
            r_40 = signif(quantile(OG_ha, prob=0.40, na.rm = TRUE), 3),
            r_60 = signif(quantile(OG_ha, prob=0.60, na.rm = TRUE), 3),
            r_80 = signif(quantile(OG_ha, prob=0.80, na.rm = TRUE), 3),
            r_95 = signif(quantile(OG_ha, prob=0.95, na.rm = TRUE), 3),
            r_min = signif(min(OG_ha, na.rm = TRUE), 3), #indicates this value is half lowest MDL
            r_max = signif(max(OG_ha, na.rm = TRUE), 3),
            r_n = length(OG_ha))

new_layer_summary_log<- wau_working %>%
  summarise(r_mean = signif(mean(log_OG, 3)),
            r_med = signif(median(log_OG, na.rm = TRUE), 3),
            r_20 = signif(quantile(log_OG, prob=0.20, na.rm = TRUE), 3),
            r_40 = signif(quantile(log_OG, prob=0.40, na.rm = TRUE), 3),
            r_60 = signif(quantile(log_OG, prob=0.60, na.rm = TRUE), 3),
            r_80 = signif(quantile(log_OG, prob=0.80, na.rm = TRUE), 3),
            r_95 = signif(quantile(log_OG, prob=0.95, na.rm = TRUE), 3),
            r_min = signif(min(log_OG, na.rm = TRUE), 3), #indicates this value is half lowest MDL
            r_max = signif(max(log_OG, na.rm = TRUE), 3),
            r_n = length(log_OG))
```

# Figures

```{r f_own plots, echo=FALSE, warning=FALSE, results='asis'}
#hist - raw data
dist<-ggplot(data=wau_working) +
  geom_histogram(mapping = aes(x=OG_ha), binwidth = 50) +
  ggtitle("Raw Data (No Transformations Applied)")
dist

# hist - log data
dist_log<-ggplot(data=wau_working) +
  geom_histogram(mapping = aes(x=log_OG), binwidth = 0.1) +
  ggtitle("Log Transformed Data") 
dist_log

# hist - sqrt data
dist_sqrt<-ggplot(data=wau_working) +
  geom_histogram(mapping = aes(x=sqrt_OG), binwidth = 0.1) +
  ggtitle("Square Root Transformed Data") 
dist_sqrt

#qq plot - normality test
log_qq <- ggqqplot(wau_working$log_OG) +
  ggtitle("Normality Test - Log Transformed Data")
log_qq

#qq plot - normality test
sqrt_qq <- ggqqplot(wau_working$log_OG) +
  ggtitle("Normality Test - Square Root Transformed Data")
sqrt_qq

plot(wau_jenks, main = "Old Growth Data - Natural Breaks (Jenks) Transformation")

#normality-test - log
ks.test(wau_working$log_OG, "pnorm", sd=sd(wau_working$log_OG))

#normality-test - sqrt
ks.test(wau_working$sqrt_OG, "pnorm", sd=sd(wau_working$sqrt_OG))

#Classify based on percentiles
wau_ranking <- wau_working %>%
  mutate(og_rank = case_when(
    OG_ha == 0 ~ 'None',
    OG_ha > 0 & OG_ha <= new_layer_summary$r_20 ~ 'Negligible',
    OG_ha > new_layer_summary$r_20 & OG_ha <= new_layer_summary$r_40 ~ 'Low',
    OG_ha > new_layer_summary$r_40 & OG_ha <= new_layer_summary$r_60 ~ 'Medium',
    OG_ha > new_layer_summary$r_60 & OG_ha <= new_layer_summary$r_80 ~ 'High',
    OG_ha > new_layer_summary$r_80 & OG_ha <= new_layer_summary$r_max ~ 'VeryHigh'
  ),
  og_rank_log = case_when(
    OG_ha == 0 ~ 'None',
    log_OG >= new_layer_summary_log$r_min & log_OG <= new_layer_summary_log$r_20 ~ 'Negligible',
    log_OG > new_layer_summary_log$r_20 & log_OG <= new_layer_summary_log$r_40 ~ 'Low',
    log_OG > new_layer_summary_log$r_40 & log_OG <= new_layer_summary_log$r_60 ~ 'Medium',
    log_OG > new_layer_summary_log$r_60 & log_OG <= new_layer_summary_log$r_80 ~ 'High',
    log_OG > new_layer_summary_log$r_80 & log_OG <= new_layer_summary_log$r_max ~ 'VeryHigh'))

stargazer(wau_ranking[23:50], title = "Summary - Data Classed by Percentiles")

# percentile histogram - raw
perc_raw<-ggplot(wau_ranking) +
  geom_bar(aes(x=og_rank)) +
  ggtitle("Raw Data Classified by Percentiles")
perc_raw

# percentile hist - logged
perc_log <-ggplot(wau_ranking) +
  geom_bar(aes(x=og_rank_log)) +
  ggtitle("Logged Data Classified by Percentiles")
perc_log

```
